<?xml version="1.0" encoding="UTF-8"?>

<!-- 試験密度測定を行なうビルドファイル。 -->

<project name="terasoluna-filedao" basedir=".." default="count">
	
  <target name="usage">
	<echo message=""/>
	<echo message="試験密度測定を行なうビルドファイル。"/>
	<echo message="----------------------------------------------------------"/>
  	<echo message="【環境設定】"/>
	<echo message="ツール「jensity」を使用する。"/>
	<echo message="試験密度の測定にはテスト対象クラスのソースコード（.javaと.class）、"/>
	<echo message="テストクラス（.class)が必要。"/>
	<echo message="また、実行環境のパスにjensity.jar、bcel.jar、stepcounter.jar、"/>
	<echo message="jensity-style.xslが必要となる。"/>
  	<echo message="----------------------------------------------------------"/>
  	<echo message="【実行可能なタスク】"/>
  	<echo message="count  --> 試験密度測定の実行"/>
  	<echo message="・出力されるファイル:${test.root}/dentityReports/result.html"/>
	<echo message=""/>
  </target>

  <!-- ●●●●● 環境設定 ■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <!-- buildディレクトリ -->
  <property name="build.dir" value="${basedir}/ant" />

  <!-- ●●●●● プロパティファイル設定 ■■■■■■■■■■■■■■■■■ -->
  <property file="${build.dir}/jensitybuild.properties" />

  <!-- ●●●●● クラスパスの設定 ■■■■■■■■■■■■■■■■■■■■ -->
  <!-- □${jensity.lib}のディレクトリにjensity.jar、bcel-5.2.jar、stepcounter.jar、-->
  <!--   jensity-style.xslを指定する必要があります -->
  <property name="jensity.classpath"
    value="${jensity.lib}/jensity.jar;
      ${jensity.lib}/bcel-5.2.jar;
      ${jensity.lib}/stepcounter.jar;" />

	
  <!-- ●●●●● 試験密度測定用プロパティ ■■■■■■■■■■■■■■■■ -->
  <!-- 中間XMLファイルの出力先 -->
  <property name="jensity.report.xml.dir" value="${result.dir}/xml" />
  
  <!-- テストクラスのサフィックス -->
  <property name="jensity.test.suffix" value="Test[0-9]*" />
  <property name="lower" value="65" />   <!-- 試験密度の許容下限値 -->
  <property name="upper" value="350" />  <!-- 試験密度の許容上限値 -->
  
  <!-- ●●●●● jensityタスク ■■■■■■■■■■■■■■■■■■■■■ -->
  <taskdef name="jensity"
	classname="jp.co.nttdata.terasoluna.jensity.DensityTask"
	classpath="${jensity.classpath}}" />
	    
  <!-- ■■■■■ 試験密度測定 実行 ■■■■■ -->
  <target name="count">
    <!-- ファイル出力先ディレクトリ作成 -->
    <delete dir="${result.dir}" />
    <mkdir dir="${result.dir}" />
    <mkdir dir="${jensity.report.xml.dir}" />
  	
  	<!-- ソースコード(クラスファイル）＋テストコード（クラスファイル）をマージする -->
  	<!-- （jensityではクラスファイルのディレクトリを１つしか指定できないため） -->
  	<property name="temp.class.dir" value="${result.dir}/temp/classes" />
  	<mkdir dir="${temp.class.dir}"/>
  	<copy todir="${temp.class.dir}" preservelastmodified="true">
      <fileset dir="${class.dir}">
	    <include name="**/*.class"/>
	  </fileset>
	</copy>
  	<copy todir="${temp.class.dir}" preservelastmodified="true">
      <fileset dir="${testclass.dir}">
	    <include name="**/*.class"/>
	  </fileset>
	</copy>

    <!-- 試験密度測定（XMLレポート出力） -->
    <!-- classdir   : クラスファイルの格納先（１つしか指定できません）
         destdir    : 中間XMLレポートの出力
         testsuffix : テストクラスのサフィックス（省略した場合は"Test"）
         fileset    : 測定対象のソースファイル -->
    <jensity classdir="${temp.class.dir}"
	   destdir="${jensity.report.xml.dir}" 
	   testsuffix="${jensity.test.suffix}" >
	  <fileset dir="${src.dir}">
        <include name="jp/terasoluna/fw/**/*.java" />
	  </fileset>
	</jensity>
		
	<!-- XMLレポートからHTMLレポートへ変換 -->
    <style basedir="${jensity.report.xml.dir}" destdir="${result.dir}" 
           extension=".html" 
    	   style="${jensity.lib}/jensity-style.xsl">
      <param name="lower" expression="${lower}" />
      <param name="upper" expression="${upper}" />
    </style>
  	
  	<!-- 作業用ファイル削除  -->
  	<delete dir="${result.dir}/temp" />
  </target> 

 </project>
 